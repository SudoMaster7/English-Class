<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Games Hub - Interactive Learning Platform</title>
    <meta name="description"
        content="Play interactive English learning games - vocabulary, grammar, listening, pronunciation and more!">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <!-- API Client (must load first) -->
    <script src="js/api.js"></script>
</head>

<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-content">
            <a href="#" class="nav-logo">🎮 English Games Hub</a>

            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <div class="nav-links">
                <a href="#games" class="nav-link active">🎯 Games</a>
                <a href="#daily-lesson" class="nav-link">📚 Daily Lesson</a>
                <a href="pages/gamification/dashboard.html" class="nav-link protected-link">👤 Dashboard</a>
                <a href="pages/gamification/leaderboard.html" class="nav-link protected-link">🏆 Rankings</a>
                <a href="pages/gamification/shop.html" class="nav-link protected-link">🛒 Loja</a>
                <a href="pages/gamification/friends.html" class="nav-link protected-link">👥 Amigos</a>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <div class="theme-toggle-slider">🌙</div>
                </button>
                <!-- Auth button with dropdown -->
                <div id="user-menu-container" style="position: relative; display: none;">
                    <button id="auth-button" class="nav-link"
                        style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;"></button>

                    <!-- Dropdown Menu -->
                    <div id="user-dropdown"
                        style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); min-width: 280px; z-index: 1000; overflow: hidden;">
                        <!-- Profile Header -->
                        <div
                            style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; color: white;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div id="dropdown-avatar"
                                    style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; border: 2px solid rgba(255,255,255,0.5);">
                                    👤</div>
                                <div>
                                    <div id="dropdown-name" style="font-weight: 700; font-size: 1.1rem;">Usuário</div>
                                    <div id="dropdown-email" style="font-size: 0.85rem; opacity: 0.9;">email@example.com
                                    </div>
                                </div>
                            </div>
                            <!-- Quick Stats -->
                            <div
                                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px;">
                                <div
                                    style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div id="dropdown-level" style="font-size: 1.25rem; font-weight: 800;">1</div>
                                    <div style="font-size: 0.7rem; opacity: 0.9;">Level</div>
                                </div>
                                <div
                                    style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div id="dropdown-xp" style="font-size: 1.25rem; font-weight: 800;">0</div>
                                    <div style="font-size: 0.7rem; opacity: 0.9;">XP</div>
                                </div>
                                <div
                                    style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div id="dropdown-coins" style="font-size: 1.25rem; font-weight: 800;">0</div>
                                    <div style="font-size: 0.7rem; opacity: 0.9;">💰 Moedas</div>
                                </div>
                            </div>
                        </div>

                        <!-- Menu Items -->
                        <div style="padding: 8px;">
                            <a href="pages/gamification/dashboard.html"
                                style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; text-decoration: none; color: #374151; transition: background 0.2s; cursor: pointer;"
                                onmouseover="this.style.background='#f3f4f6'"
                                onmouseout="this.style.background='transparent'">
                                <span style="font-size: 1.5rem;">👤</span>
                                <div>
                                    <div style="font-weight: 600;">Meu Dashboard</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">Ver perfil completo</div>
                                </div>
                            </a>
                            <div style="height: 1px; background: #e5e7eb; margin: 4px 8px;"></div>
                            <button onclick="API.logout()"
                                style="width: 100%; display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; text-decoration: none; color: #dc2626; border: none; background: transparent; cursor: pointer; transition: background 0.2s; text-align: left;"
                                onmouseover="this.style.background='#fee2e2'"
                                onmouseout="this.style.background='transparent'">
                                <span style="font-size: 1.5rem;">🚪</span>
                                <div>
                                    <div style="font-weight: 600;">Sair</div>
                                    <div style="font-size: 0.75rem; color: #ef4444;">Fazer logout</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Hero Section -->
        <section class="section" style="padding-top: 4rem;">
            <div class="glass-card" style="padding: 3rem; text-align: center;">
                <h1
                    style="font-size: 3rem; background: linear-gradient(135deg, #10b981 0%, #059669 50%, #34d399 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 1rem;">
                    Learn English Through Games! 🚀
                </h1>
                <p style="font-size: 1.25rem; color: var(--text-secondary); max-width: 700px; margin: 0 auto;">
                    Master vocabulary, grammar, listening, and pronunciation with our interactive mini-games. Track your
                    progress and unlock achievements!
                </p>
            </div>
        </section>

        <!-- Quick Stats Dashboard -->
        <section id="stats" class="section">
            <div class="glass-card" style="padding: 2rem;">
                <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    📊 Your Progress
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div
                        style="text-align: center; padding: 1.5rem; background: var(--gradient-primary); color: white; border-radius: var(--border-radius-md);">
                        <div style="font-size: 2.5rem; font-weight: 800;" id="totalGames">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Games Played</div>
                    </div>
                    <div
                        style="text-align: center; padding: 1.5rem; background: var(--gradient-success); color: white; border-radius: var(--border-radius-md);">
                        <div style="font-size: 2.5rem; font-weight: 800;" id="totalScore">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Points</div>
                    </div>
                    <div
                        style="text-align: center; padding: 1.5rem; background: var(--gradient-warning); color: white; border-radius: var(--border-radius-md);">
                        <div style="font-size: 2.5rem; font-weight: 800;" id="achievementCount">0/10</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Achievements</div>
                    </div>
                    <div
                        style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%); color: white; border-radius: var(--border-radius-md);">
                        <div style="font-size: 2.5rem; font-weight: 800;" id="timeSpent">0m</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Time Spent</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Level Progress Widget -->
        <section class="section" style="padding-top: 1rem;">
            <div class="glass-card"
                style="padding: 2rem; background: linear-gradient(135deg, rgba(192, 170, 243, 0.87), rgba(128, 230, 162, 0.541)); border: 2px solid rgba(139, 92, 246, 0.3);">
                <div
                    style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1.5rem;">
                    <div style="flex: 1; min-width: 250px;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div
                                style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 800; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);">
                                <span id="currentLevelNumber">1</span>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">
                                    Current Level</div>
                                <h3 style="color: var(--text-primary); margin: 0; font-size: 1.5rem; font-weight: 700;">
                                    Level <span id="levelDisplay">1</span></h3>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;"><span
                                        id="currentXP">0</span> / <span id="nextLevelXP">100</span> XP</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 600;"><span
                                        id="xpPercentage">0</span>%</span>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.15); height: 12px; border-radius: 20px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                <div id="xpProgressBar"
                                    style="height: 100%; background: linear-gradient(90deg, #8b5cf6, #6366f1, #06b6d4); width: 0%; transition: width 0.8s ease; box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);">
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; color: var(--text-secondary); font-size: 0.8rem;">?? <span
                                    id="xpToNext">100</span> XP to Level <span id="nextLevel">2</span></div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">Total XP
                        </div>
                        <div style="font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, #8b5cf6, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
                            id="totalXP">0</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Thematic Lessons Section -->
        <section id="lessons" class="section">
            <h2 style="margin-bottom: 2rem; font-size: 2.5rem; color: var(--text-primary);">
                📚 Thematic Lessons
            </h2>

            <!-- Current Lesson Display -->
            <div class="glass-card" style="padding: 2rem; margin-bottom: 2rem; background: var(--gradient-primary);">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <p style="color: rgba(255,255,255,0.9); margin-bottom: 0.5rem; font-size: 0.9rem;">CURRENT
                            LESSON</p>
                        <h3 id="currentLessonTitle" style="color: white; font-size: 1.75rem; margin: 0;">
                            🏠 Daily Routines - A1
                        </h3>
                    </div>
                    <button onclick="startCurrentLesson()" class="btn"
                        style="background: var(--bg-glass); color: var(--color-primary); font-weight: 700; min-width: 180px; border: 2px solid var(--color-primary);">
                        Continue Learning →
                    </button>
                </div>
            </div>

            <!-- Placement Test Card -->
            <div class="glass-card"
                style="padding: 2rem; margin-bottom: 2rem; background: linear-gradient(135deg, rgba(192, 170, 243, 0.87), rgba(128, 230, 162, 0.541)); border: 2px solid rgba(139, 92, 246, 0.3);">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
                    <div style="flex: 1; min-width: 250px;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 3rem;">📝</div>
                            <div>
                                <h3 style="color: var(--text-primary); margin: 0; font-size: 1.5rem;">Teste de
                                    Nivelamento</h3>
                                <p style="color: var(--text-secondary); margin: 0; margin-top: 0.25rem;">Descubra seu
                                    nível de inglês!</p>
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 0;">
                            Responda 20 questões progressivas e descubra seu nível CEFR (A1 a C2).
                            Receba recomendações personalizadas de por onde começar seus estudos.
                        </p>
                    </div>
                    <div>
                        <button onclick="window.location.href='pages/lessons/placement-test.html'" class="btn"
                            style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 700; padding: 1rem 2rem; font-size: 1.1rem; min-width: 200px; white-space: nowrap;">
                            ✨ Fazer Teste
                        </button>
                    </div>
                </div>
            </div>

            <!-- Theme Selector -->
            <div id="themesContainer"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Theme cards will be inserted here by JavaScript -->
            </div>
        </section>

        <!-- Games Grid -->
        <section id="games" class="section">
            <h2 style="margin-bottom: 2rem; font-size: 2.5rem; color: var(--text-primary);">
                🎮 Practice Games
            </h2>
            <div class="game-grid">
                <!-- Memory Match Game -->
                <div class="glass-card game-card" onclick="navigateToGame('memory-match')">
                    <div class="game-badge">New</div>
                    <div class="game-card-content">
                        <div class="game-icon">🃏</div>
                        <h3 class="game-title">Memory Match</h3>
                        <p class="game-description">Match English words with Portuguese translations</p>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            <span class="btn btn-primary">Play Now</span>
                        </div>
                    </div>
                </div>

                <!-- Word Scramble -->
                <div class="glass-card game-card" onclick="navigateToGame('word-scramble')">
                    <div class="game-badge">New</div>
                    <div class="game-card-content">
                        <div class="game-icon">🔤</div>
                        <h3 class="game-title">Word Scramble</h3>
                        <p class="game-description">Unscramble jumbled English words</p>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            <span class="btn btn-primary">Play Now</span>
                        </div>
                    </div>
                </div>

                <!-- Typing Challenge -->
                <div class="glass-card game-card" onclick="navigateToGame('typing-challenge')">
                    <div class="game-badge">New</div>
                    <div class="game-card-content">
                        <div class="game-icon">⌨️</div>
                        <h3 class="game-title">Typing Challenge</h3>
                        <p class="game-description">Type English sentences quickly and accurately</p>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            <span class="btn btn-primary">Play Now</span>
                        </div>
                    </div>
                </div>

                <!-- Listening Game -->
                <div class="glass-card game-card" onclick="navigateToGame('listening-game')">
                    <div class="game-badge">New</div>
                    <div class="game-card-content">
                        <div class="game-icon">🎧</div>
                        <h3 class="game-title">Listening Game</h3>
                        <p class="game-description">Listen and select the correct answer</p>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            <span class="btn btn-primary">Play Now</span>
                        </div>
                    </div>
                </div>

                <!-- Pronunciation Practice -->
                <div class="glass-card game-card" onclick="navigateToGame('pronunciation-game')">
                    <div class="game-badge">New</div>
                    <div class="game-card-content">
                        <div class="game-icon">🎤</div>
                        <h3 class="game-title">Pronunciation</h3>
                        <p class="game-description">Practice speaking English words correctly</p>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            <span class="btn btn-primary">Play Now</span>
                        </div>
                    </div>
                </div>

                <!-- Crossword Puzzle -->
                <div class="glass-card game-card" onclick="navigateToGame('crossword')">
                    <div class="game-badge">New</div>
                    <div class="game-card-content">
                        <div class="game-icon">🧩</div>
                        <h3 class="game-title">Crossword Puzzle</h3>
                        <p class="game-description">Complete the vocabulary crossword</p>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            <span class="btn btn-primary">Play Now</span>
                        </div>
                    </div>
                </div>

                <!-- Daily Lesson (Original) -->
                <div class="glass-card game-card" onclick="navigateToGame('daily-lesson')">
                    <div class="game-card-content">
                        <div class="game-icon">🌅</div>
                        <h3 class="game-title">Daily Routines</h3>
                        <p class="game-description">Interactive lesson with quiz and activities</p>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            <span class="btn btn-primary">Start Lesson</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Achievements Section -->
        <section id="achievements" class="section">
            <div class="glass-card" style="padding: 2rem;">
                <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    🏆 Achievements
                </h2>
                <div id="achievementsList"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                    <!-- Achievements will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="section" style="text-align: center; padding: 2rem 0;">
            <p style="color: white; opacity: 0.9; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                Made with 💜 by SUDO - 2026
            </p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/achievements.js"></script>
    <script src="js/lessons.js"></script>
    <script src="js/lesson-ui.js"></script>
    <script>
        // Initialize theme
        ThemeManager.init();
        SoundFX.init();

        // Toggle theme function
        function toggleTheme() {
            const newTheme = ThemeManager.toggle();
            const slider = document.querySelector('.theme-toggle-slider');
            slider.textContent = newTheme === 'dark' ? '☀️' : '🌙';
            SoundFX.play('click');
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            const btn = document.querySelector('.mobile-menu-btn');
            navLinks.classList.toggle('active');
            btn.classList.toggle('active');
            SoundFX.play('click');
        }

        // Navigate to game
        function navigateToGame(gameName) {
            SoundFX.play('click');
            if (gameName === 'daily-lesson') {
                window.location.href = 'pages/lessons/daily-lesson.html';
            } else {
                window.location.href = `games/${gameName}.html`;
            }
        }

        // ========================================
        // Auth Integration
        // ========================================
        const authButton = document.getElementById('auth-button');
        const userMenuContainer = document.getElementById('user-menu-container');
        const userDropdown = document.getElementById('user-dropdown');

        // Custom notification for placement test
        function showPlacementNotification() {
            // Create notification banner
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                max-width: 400px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 24px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.5s ease-out;
            `;

            notification.innerHTML = `
                <style>
                    @keyframes slideIn {
                        from { transform: translateX(120%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(120%); opacity: 0; }
                    }
                </style>
                <div style="display: flex; align-items: start; gap: 16px;">
                    <div style="font-size: 32px; line-height: 1;">🎯</div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700;">Complete o Teste de Nivelamento!</h3>
                        <p style="margin: 0 0 16px 0; opacity: 0.95; font-size: 14px; line-height: 1.5;">
                            Descubra seu nível de inglês e ganhe <strong>100 moedas</strong> 💰
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="window.location.href='pages/lessons/placement-test.html'" 
                                style="padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                Fazer Agora
                            </button>
                            <button id="dismissNotification"
                                style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                Mais Tarde
                            </button>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; line-height: 1; opacity: 0.7;">
                        ×
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            // Dismiss button
            notification.querySelector('#dismissNotification').onclick = () => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            };

            // Auto-dismiss after 15 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 15000);
        }

        // Initialize auth UI
        async function initAuth() {
            if (API && API.isAuthenticated()) {
                try {
                    // Fetch fresh user data from backend
                    const response = await API.auth.getCurrentUser();

                    if (response.success && response.data.user) {
                        const user = response.data.user;

                        // Update localStorage with fresh data
                        localStorage.setItem('user', JSON.stringify(user));

                        // Show user menu container
                        userMenuContainer.style.display = 'block';
                        authButton.textContent = `👤 ${user.name}`;

                        // Populate dropdown with user data
                        const profile = user.profile || {};
                        const avatar = (user.avatar && !user.avatar.startsWith('http')) ? user.avatar : '👤';
                        document.getElementById('dropdown-avatar').textContent = avatar;
                        document.getElementById('dropdown-name').textContent = user.name;
                        document.getElementById('dropdown-email').textContent = user.email;
                        document.getElementById('dropdown-level').textContent = profile.level || 1;
                        document.getElementById('dropdown-xp').textContent = (profile.xp || 0).toLocaleString('pt-BR');
                        document.getElementById('dropdown-coins').textContent = (profile.coins || 0).toLocaleString('pt-BR');

                        // Toggle dropdown on button click
                        authButton.onclick = async (e) => {
                            e.stopPropagation();
                            const isVisible = userDropdown.style.display === 'block';
                            if (!isVisible) {
                                // Refresh user data before showing
                                await refreshUserData();
                            }
                            userDropdown.style.display = isVisible ? 'none' : 'block';
                            SoundFX.play('click');
                        };

                        // Check placement test completion (only show once per session)
                        const placementAlertShown = sessionStorage.getItem('placementAlertShown');
                        if (!user.placementTestCompleted && !placementAlertShown) {
                            // Show custom notification instead of browser alert
                            setTimeout(() => {
                                showPlacementNotification();
                                sessionStorage.setItem('placementAlertShown', 'true');
                            }, 1500);
                        }

                        // Show user stats if available
                        if (profile.xp !== undefined) {
                            API.showNotification(`Bem-vindo de volta, ${user.name}! 🎉`, 'success');
                            // Update stats with backend data
                            document.getElementById('totalGames').textContent = user.level || 1;
                            document.getElementById('totalScore').textContent = user.xp || 0;

                            // Update level widget with backend profile data
                            updateLevelProgress(profile);
                        }
                    } else {
                        // Failed to get user data, logout
                        API.logout();
                    }
                } catch (error) {
                    console.error('Error initializing auth:', error);
                    // Continue without user data or logout on auth error
                    API.logout();
                }
            } else {
                // Not authenticated - show login button
                authButton.textContent = '🔐 Entrar';
                authButton.onclick = () => {
                    window.location.href = 'pages/auth/login.html';
                };
                userMenuContainer.style.display = 'block';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (userDropdown && !userMenuContainer.contains(e.target)) {
                userDropdown.style.display = 'none';
            }
        });

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAuth);
        } else {
            initAuth();
        }

        // Refresh user data from backend
        async function refreshUserData() {
            try {
                const response = await API.auth.getCurrentUser();
                if (response.success && response.data.user) {
                    const user = response.data.user;
                    const profile = user.profile || {};

                    // Update dropdown
                    document.getElementById('dropdown-level').textContent = profile.level || 1;
                    document.getElementById('dropdown-xp').textContent = (profile.xp || 0).toLocaleString('pt-BR');
                    document.getElementById('dropdown-coins').textContent = (profile.coins || 0).toLocaleString('pt-BR');

                    // Update localStorage
                    localStorage.setItem('user', JSON.stringify(user));
                }
            } catch (error) {
                console.error('Error refreshing user data:', error);
            }
        }

        // Update stats dashboard
        function updateDashboard() {
            const stats = UserProgress.getStats();

            document.getElementById('totalGames').textContent = stats.gamesPlayed;
            document.getElementById('totalScore').textContent = stats.totalScore;

            const progress = Achievements.getProgress();
            document.getElementById('achievementCount').textContent =
                `${progress.unlocked}/${progress.total}`;

            const minutes = Math.floor(stats.timeSpent / 60);
            document.getElementById('timeSpent').textContent =
                minutes < 60 ? `${minutes}m` : `${Math.floor(minutes / 60)}h ${minutes % 60}m`;

            // Update level progress
            updateLevelProgress(stats);
        }
        // Update level progress widget
        function updateLevelProgress(statsOrProfile) {
            let level, currentLevelXP, nextLevelXP, xpToNext, percentage, totalXP;

            // Check if we received a backend profile or local stats
            if (statsOrProfile.level !== undefined && statsOrProfile.xp !== undefined) {
                // It's a backend profile
                level = statsOrProfile.level;
                totalXP = statsOrProfile.xp;

                // Calculate progress within current level (assuming 100 XP per level for consistency, 
                // or use the backend logic if it differs. Model says 100 XP per level).
                currentLevelXP = totalXP % 100;
                nextLevelXP = 100;
                xpToNext = nextLevelXP - currentLevelXP;
                percentage = Math.round((currentLevelXP / nextLevelXP) * 100);
            } else {
                // It's local stats (fallback)
                // Calculate total XP (1 XP per 10 points scored)
                totalXP = Math.floor((statsOrProfile.totalScore || 0) / 10);

                // Calculate level (every 100 XP = 1 level, starting at level 1)
                level = Math.floor(totalXP / 100) + 1;
                currentLevelXP = totalXP % 100;
                nextLevelXP = 100;
                xpToNext = nextLevelXP - currentLevelXP;
                percentage = Math.round((currentLevelXP / nextLevelXP) * 100);
            }

            // Update display
            const levelNumEl = document.getElementById('currentLevelNumber');
            const levelDisplayEl = document.getElementById('levelDisplay');
            const totalXPEl = document.getElementById('totalXP');
            const currentXPEl = document.getElementById('currentXP');
            const nextLevelXPEl = document.getElementById('nextLevelXP');
            const xpPercentageEl = document.getElementById('xpPercentage');
            const xpBarEl = document.getElementById('xpProgressBar');
            const xpToNextEl = document.getElementById('xpToNext');
            const nextLevelEl = document.getElementById('nextLevel');

            if (levelNumEl) levelNumEl.textContent = level;
            if (levelDisplayEl) levelDisplayEl.textContent = level;
            // Use toLocaleString for Total XP if possible
            if (totalXPEl) totalXPEl.textContent = totalXP.toLocaleString('pt-BR');
            if (currentXPEl) currentXPEl.textContent = currentLevelXP;
            if (nextLevelXPEl) nextLevelXPEl.textContent = nextLevelXP;
            if (xpPercentageEl) xpPercentageEl.textContent = percentage;
            if (xpBarEl) xpBarEl.style.width = percentage + '%';
            if (xpToNextEl) xpToNextEl.textContent = xpToNext;
            if (nextLevelEl) nextLevelEl.textContent = level + 1;
        }

        // Load achievements
        function loadAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            const allAchievements = Achievements.getAll();
            const stats = UserProgress.getStats();
            const unlockedIds = stats.achievements || [];

            achievementsList.innerHTML = allAchievements.map(achievement => {
                const isUnlocked = unlockedIds.includes(achievement.id);
                return `
                    <div class="glass-card" style="padding: 1.5rem; text-align: center; ${isUnlocked ? '' : 'opacity: 0.5; filter: grayscale(1);'}">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">${achievement.icon}</div>
                        <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-primary);">
                            ${achievement.name}
                        </h3>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                            ${achievement.description}
                        </p>
                        ${isUnlocked ? '<div style="margin-top: 0.5rem; color: #10b981; font-weight: 600; font-size: 0.9rem;">✓ Unlocked</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        // Smooth scroll for navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const href = link.getAttribute('href');
                if (href && href.startsWith('#')) {
                    e.preventDefault();
                    const target = document.querySelector(href);
                    if (target) {
                        SoundFX.play('click');
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });

                        // Update active state
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    }
                }
            });
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            loadAchievements();
            loadLessons(); // Initialize lesson system
            const currentTheme = ThemeManager.getCurrent();
            document.querySelector('.theme-toggle-slider').textContent = currentTheme === 'dark' ? '☀️' : '🌙';

            // Protected links handler
            document.querySelectorAll('.protected-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    if (!API.isAuthenticated()) {
                        e.preventDefault();
                        API.showNotification('Faça login para acessar esta área! 🔐', 'info');
                        setTimeout(() => {
                            window.location.href = 'pages/auth/login.html';
                        }, 1000);
                    }
                });
            });
        });
    </script>
</body>

</html>